<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jacozinho do Senhor</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
        :root {
            --cor-primaria: #5D4037; --cor-secundaria: #8D6E63;
            --cor-fundo: #EFEBE9; --cor-texto: #3E2723;
            --cor-branco: #FFFFFF; --cor-sucesso: #2E7D32; --cor-aviso: #FBC02D; --cor-erro: #D32F2F;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--cor-fundo); color: var(--cor-texto); display: flex; justify-content: center; min-height: 100vh; padding-bottom: 80px;}
        .app-container { background: var(--cor-branco); width: 100%; max-width: 900px; box-shadow: 0 4px 20px rgba(93,64,55,0.15); min-height: 100vh; display: flex; flex-direction: column; }
        header { background: white; padding: 15px; text-align: center; border-bottom: 4px solid var(--cor-primaria); }
        .logo-img { max-width: 150px; display: block; margin: 0 auto 5px auto; }
        .abas { display: flex; background: #D7CCC8; }
        .aba { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; color: #5D4037; border-bottom: 3px solid transparent; transition: 0.3s;}
        .aba:hover { background: #EFEBE9; }
        .aba.ativa { background: white; border-bottom: 3px solid var(--cor-primaria); color: var(--cor-primaria); }
        main { padding: 20px; flex-grow: 1; }
        .view-section { display: none; opacity: 0; transition: opacity 0.3s; }
        .view-section.ativa { display: block; opacity: 1; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
        label { font-size: 0.8rem; color: var(--cor-secundaria); font-weight: 700; margin-bottom: 5px; display: block; text-transform: uppercase; margin-top: 15px;}
        input, select, textarea { width: 100%; padding: 10px; border: 2px solid #D7CCC8; border-radius: 8px; font-size: 0.95rem; margin-bottom: 5px; background: #fff; font-family: inherit;}
        .btn-salvar { width: 100%; padding: 15px; background-color: var(--cor-primaria); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 20px; font-size: 1rem; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-mini { padding: 8px 15px; font-size: 0.85rem; background: #D7CCC8; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-zap { background-color: #25D366; color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; font-size: 0.8rem; }
        #areaImportar { display:none; background:#E3F2FD; border-color:#2196F3; }
        .import-box { width: 100%; height: 150px; padding: 10px; font-family: monospace; font-size: 0.85rem; border: 2px solid #90CAF9; border-radius: 8px; }
        #areaCalendarioPDF { background-color: #ffffff !important; padding: 10px; color: #000; width: 100%; }
        .logo-pdf { display: none; text-align: center; margin-bottom: 10px; } .logo-pdf img { height: 60px; }
        .calendario-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; background: var(--cor-primaria); color: white; padding: 12px; border-radius: 8px 8px 0 0; }
        .grid-dias { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; text-align: center; font-weight: bold; color: var(--cor-branco); background: var(--cor-secundaria); padding: 8px 0; font-size: 0.8rem; }
        .grid-calendario { display: grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: 95px; gap: 1px; background: #D7CCC8; border: 2px solid var(--cor-secundaria); }
        .dia-cal { background: #FFF; padding: 2px; cursor: pointer; position: relative; font-size: 0.8rem; display: flex; flex-direction: column; overflow: hidden; }
        .dia-cal:hover { background: #FFF8E1; overflow-y: auto; }
        .dia-cal.hoje { background: #E0F2F1; }
        .evento-chip { font-size: 0.65rem; background: var(--cor-primaria); color: white; padding: 3px 5px; border-radius: 3px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; display: block; line-height: 1.2; }
        .pendente { background: var(--cor-aviso) !important; color: #3E2723 !important; }
        #barraSalvar { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #3E2723; color: white; padding: 12px 25px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); z-index: 1000; align-items: center; gap: 15px; }
        .area-modal { display: none; background: #FFF; padding: 20px; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-left: 5px solid var(--cor-primaria); }
        .checklist-container { border: 2px solid #D7CCC8; border-radius: 8px; max-height: 250px; overflow-y: auto; padding: 10px; background: #FAFAFA; }
        .checklist-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .checklist-item input { margin-right: 10px; width: 18px; height: 18px; accent-color: var(--cor-primaria); }
        .card-escala { background: #FFF; border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; border-left: 5px solid var(--cor-primaria); box-shadow: 0 2px 5px rgba(0,0,0,0.05); align-items: center; }
        .btn-acao { border: none; background: none; font-size: 1.2rem; cursor: pointer; opacity: 0.7; }
        .esconder-na-foto { display: inline-block; }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <img src="logo.png" class="logo-img">
            <div class="abas">
                <div class="aba ativa" onclick="mudarAba('tab-escala', this)">üìã ESCALAS</div>
                <div class="aba" onclick="mudarAba('tab-calendario', this)">üìÖ CALEND√ÅRIO</div>
            </div>
        </header>

        <main>
            <div id="tab-escala" class="view-section ativa">
                <div style="display:flex; gap:10px; margin-bottom:15px">
                    <button onclick="toggleArea('areaCadastro')" class="btn-mini" style="flex:1">‚ûï Novo Servo</button>
                    <button onclick="toggleArea('areaGerenciar'); carregarParaGerenciar()" class="btn-mini" style="flex:1">‚öôÔ∏è Gerenciar</button>
                </div>

                <div id="areaCadastro" class="area-modal">
                    <h3 style="color:var(--cor-primaria)">Novo Cadastro</h3>
                    <input type="text" id="novoNome" placeholder="Nome Completo">
                    <input type="text" id="novoTelefone" placeholder="WhatsApp (Ex: 83999998888)">
                    <select id="novoMinisterio"><option value="M√∫sica">M√∫sica</option><option value="Acolhida">Acolhida</option><option value="Prega√ß√£o">Prega√ß√£o</option><option value="Intercess√£o">Intercess√£o</option><option value="Outros">Outros</option></select>
                    <button id="btnSalvarServo" onclick="salvarNovoServo()" class="btn-mini" style="width:100%; margin-top:10px; background:var(--cor-primaria); color:white">Salvar Cadastro</button>
                </div>
                
                <div id="areaGerenciar" class="area-modal">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                        <h3>Gerenciar Equipe</h3>
                        <button onclick="toggleArea('areaImportar')" class="btn-mini" style="background:#2196F3; color:white">üì§ Importar Lista</button>
                    </div>

                    <div id="areaImportar" class="area-modal" style="border:none; padding:10px; margin-bottom:10px;">
                        <h4>Importador Turbo üöÄ</h4>
                        <p style="font-size:0.8rem; color:#666">Cole a lista abaixo (Nome, Telefone):</p>
                        <textarea id="txtImportar" class="import-box" placeholder="Cole sua lista aqui..."></textarea>
                        <button onclick="processarImportacao()" class="btn-mini" style="background:#4CAF50; color:white; width:100%; margin-top:5px">Processar e Salvar</button>
                    </div>

                    <input type="text" id="buscaGerencia" placeholder="Buscar..." onkeyup="filtrarGerencia()">
                    <div id="listaGerencia" style="max-height:200px;overflow-y:auto; margin-top:10px"></div>
                </div>

                <form id="formEscala">
                    <label>Respons√°vel:</label> <input type="text" id="inputResponsavel" required>
                    <label>Data:</label> <input type="date" id="dataEscala" required onchange="carregarEscalaDoDia()">
                    <label>Minist√©rio:</label> 
                    <select id="selectMinisterio" required onchange="filtrarListaPorMinisterio()">
                        <option value="">Selecione...</option>
                        <option value="Geral">Todos</option>
                        <option value="M√∫sica">M√∫sica</option>
                        <option value="Comunica√ß√£o">Comunica√ß√£o</option>
                        <option value="Acolhida">Acolhida</option>
                        <option value="Prega√ß√£o">Prega√ß√£o</option>
                        <option value="Intercess√£o">Intercess√£o</option>
                        <option value="Crian√ßas">Crian√ßas</option>
                        <option value="Coordena√ß√£o">Coordena√ß√£o</option>
                        <option value="Promo√ß√£o Humana">Promo√ß√£o Humana</option>
                        <option value="Jovem">Jovem</option>
                        <option value="Forma√ß√£o">Forma√ß√£o</option>
                        <option value="Fam√≠lias">Fam√≠lias</option>
                    </select>
                    <div class="checklist-container" id="containerChecklist"><p style="text-align:center;color:#999;padding:10px">Selecione uma fun√ß√£o acima...</p></div>
                    <div style="margin-top:5px"><button type="button" class="btn-mini" onclick="marcarTodos(true)">Todos</button> <button type="button" class="btn-mini" onclick="marcarTodos(false)">Nenhum</button></div>
                    <button type="submit" id="btnSalvarEscala" class="btn-salvar">Confirmar Escala</button>
                </form>
                <div id="areaParaImagem" style="background:white;padding:10px;margin-top:20px;border:1px solid #eee;border-radius:8px">
                    <h3 style="text-align:center;color:#5D4037;border-bottom:2px solid #5D4037;margin-bottom:10px">ESCALA DO DIA <span id="dataTitulo">--/--</span></h3>
                    <div id="listaEscalados"></div>
                </div>
                <button onclick="gerarImagem()" class="btn-salvar" style="background:var(--cor-sucesso);margin-top:10px">üì∏ Baixar Imagem (JPG)</button>
            </div>

            <div id="tab-calendario" class="view-section">
                <div id="areaCalendarioPDF">
                    <div class="logo-pdf" id="logoPdfHeader"><img src="logo.png" alt="Logo"></div>
                    <div class="calendario-header">
                        <button class="btn-mini esconder-na-foto" onclick="mudarMes(-1)">‚óÄ</button>
                        <h2 id="mesAnoDisplay" style="margin:0; text-transform:uppercase; letter-spacing:1px; font-size:1.2rem">M√™s / Ano</h2>
                        <button class="btn-mini esconder-na-foto" onclick="mudarMes(1)">‚ñ∂</button>
                    </div>
                    <div class="grid-dias"><div>DOM</div><div>SEG</div><div>TER</div><div>QUA</div><div>QUI</div><div>SEX</div><div>S√ÅB</div></div>
                    <div id="calendarioGrid" class="grid-calendario"></div>
                </div>
                <button id="btnBaixarPDF" onclick="gerarPDFCalendario()" class="btn-salvar" style="background:#D32F2F; margin-top:10px">üìÑ Baixar Calend√°rio (PDF A4)</button>
                <div id="modalEvento" class="area-modal" style="margin-top:20px;">
                    <h3>Novo Compromisso</h3>
                    <div style="display:flex; gap:10px;"><div style="flex:1"><label>In√≠cio:</label><input type="date" id="evDataInicio" readonly style="background:#EEE"></div><div style="flex:1"><label>Final:</label><input type="date" id="evDataFim"></div></div>
                    <label>T√≠tulo:</label><input type="text" id="evTitulo" list="sugestoesTitulos" placeholder="Digite ou selecione..."><datalist id="sugestoesTitulos"><option value="SANTA MISSA"><option value="REUNI√ÉO"><option value="RETIRO"><option value="FORMA√á√ÉO"><option value="GRUPO DE ORA√á√ÉO"><option value="ADORA√á√ÉO"><option value="VIG√çLIA"></datalist>
                    <label>Minist√©rio:</label><select id="evMinisterio"><option value="Geral">Geral</option><option value="M√∫sica">M√∫sica</option><option value="Acolhida">Acolhida</option><option value="Prega√ß√£o">Prega√ß√£o</option><option value="Coordena√ß√£o">Coordena√ß√£o</option><option value="Outros">Outros</option></select>
                    <div style="display:flex;gap:10px;margin-top:15px"><button onclick="fecharModalEvento()" class="btn-mini" style="background:#999;flex:1">Cancelar</button><button onclick="adicionarAFila()" class="btn-mini" style="background:var(--cor-aviso);color:#3E2723;flex:1">‚ûï Adicionar √† Lista</button></div>
                </div>
                <div id="listaEventosDia" style="margin-top:20px"></div>
            </div>
        </main>
        
        <div id="barraSalvar"><span id="txtPendentes">0 altera√ß√µes</span><button id="btnSalvarFila" onclick="processarFila()" class="btn-mini" style="background:#4CAF50; color:white; font-size:1rem; padding:8px 15px">üíæ SALVAR TUDO</button></div>
    </div>

    <script>
        let todosServos = []; let eventosMes = []; let filaPendentes = []; let dataCalendario = new Date();
        function toast(msg, tipo = "sucesso") { const cor = tipo === "sucesso" ? "var(--cor-sucesso)" : "var(--cor-erro)"; Toastify({ text: msg, duration: 3000, gravity: "top", position: "right", style: { background: cor, borderRadius: "8px" } }).showToast(); }
        function setLoading(btnId, isLoading, textNormal = "Salvar") { const btn = document.getElementById(btnId); if(!btn) return; if(isLoading) { btn.disabled = true; btn.innerText = "‚è≥ Processando..."; btn.style.opacity = "0.7"; } else { btn.disabled = false; btn.innerText = textNormal; btn.style.opacity = "1"; } }
        function mudarAba(id, el) { document.querySelectorAll('.view-section').forEach(v => v.classList.remove('ativa')); document.getElementById(id).classList.add('ativa'); document.querySelectorAll('.aba').forEach(a => a.classList.remove('ativa')); el.classList.add('ativa'); if(id==='tab-calendario') carregarEventosDoMes(); }
        function toggleArea(id) { const el=document.getElementById(id); el.style.display=el.style.display==='block'?'none':'block'; }
        function enviarZap(telefone, nome, data, ministerio) { if(!telefone) return toast("Servo sem telefone cadastrado!", "erro"); const nums = telefone.replace(/\D/g, ""); const msg = `Ol√° ${nome}, a Paz! üôè%0A%0AVoc√™ foi escalado(a) para o minist√©rio *${ministerio}* no dia *${data}*.%0A%0APor favor, confirme sua presen√ßa.`; window.open(`https://wa.me/55${nums}?text=${msg}`, '_blank'); }

        // --- IMPORTADOR TURBO INTELIGENTE (ATUALIZADO) ---
        async function processarImportacao() {
            const texto = document.getElementById('txtImportar').value;
            if(!texto.trim()) return toast("Cole a lista primeiro!", "erro");

            const linhas = texto.split('\n');
            const senha = prompt(`Processar ${linhas.length} nomes?\nüîí Digite a Senha:`);
            if(!senha) return;

            let criados = 0;
            let atualizados = 0;
            
            toast("Iniciando... isso pode levar uns segundos.");

            for(const linha of linhas) {
                if(!linha.includes(',')) continue; 
                
                const partes = linha.split(',');
                const nomeImport = partes[0].trim();
                const foneImport = partes[1].trim();

                // Busca se j√° existe (ignorando mai√∫sculas/min√∫sculas)
                const servoExistente = todosServos.find(s => s.nome.toLowerCase() === nomeImport.toLowerCase());

                if(servoExistente) {
                    // ATUALIZA O TELEFONE
                    await fetch(`/servos/${servoExistente.id}`, {
                        method: 'PUT', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ nome: servoExistente.nome, ministerio: servoExistente.ministerio, telefone: foneImport, senha: senha })
                    });
                    atualizados++;
                } else {
                    // CRIA NOVO (Minist√©rio "Outros" padr√£o)
                    await fetch('/servos', {
                        method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ nome: nomeImport, ministerio: "Outros", telefone: foneImport }) // OBS: Aqui criei sem senha pois o endpoint POST /servos atual n√£o pede senha (padr√£o cadastro aberto), mas se pedir, adicione.
                    });
                    criados++;
                }
            }

            toast(`Conclu√≠do! ${criados} novos, ${atualizados} atualizados.`);
            document.getElementById('txtImportar').value = "";
            toggleArea('areaImportar');
            carregarDadosIniciais();
        }

        // --- FUN√á√ïES PADR√ÉO (MANTIDAS) ---
        async function carregarDadosIniciais(){try{const r=await fetch('/servos');todosServos=await r.json();}catch(e){}}
        async function salvarNovoServo(){ const n=document.getElementById('novoNome').value;const m=document.getElementById('novoMinisterio').value;const t=document.getElementById('novoTelefone').value; if(!n)return toast("Preencha o nome","erro"); setLoading('btnSalvarServo', true); await fetch('/servos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nome:n,ministerio:m,telefone:t})}); setLoading('btnSalvarServo', false, "Salvar Cadastro"); toast("Cadastro Realizado!");toggleArea('areaCadastro');carregarDadosIniciais(); }
        async function carregarEscalaDoDia(){ const d=document.getElementById('dataEscala').value;if(!d)return;document.getElementById('dataTitulo').innerText=d.split('-').reverse().join('/'); const div=document.getElementById('listaEscalados');div.innerHTML="Carregando..."; const r=await fetch(`/escalas/${d}`);const l=await r.json();div.innerHTML=""; if(l.length === 0) { div.innerHTML = "<p style='text-align:center;color:#999'>Ningu√©m escalado.</p>"; return; } l.forEach(i=>{ const dataFormatada = d.split('-').reverse().join('/'); let btnZap = ""; if(i.servos?.telefone) { btnZap = `<button class="btn-zap" onclick="enviarZap('${i.servos.telefone}', '${i.servos.nome}', '${dataFormatada}', '${i.ministerio_nome}')">üì± Avisar</button>`; } div.innerHTML+=` <div class='card-escala'> <div><b>${i.servos?.nome}</b><br><small>${i.ministerio_nome}</small></div> <div style="display:flex; align-items:center; gap:10px;"> ${btnZap} <button class='btn-acao' onclick='delEscala(${i.id})' style="color:red">‚ùå</button> </div> </div>` }) }
        function carregarParaGerenciar(){const d=document.getElementById('listaGerencia');d.innerHTML="";todosServos.forEach(s=>d.innerHTML+=`<div style='display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee; background:#FAFAFA; margin-bottom:5px; border-radius:5px'><div><b>${s.nome}</b><br><small>${s.ministerio}</small><br><small style='color:green'>${s.telefone || "Sem Zap"}</small></div><button onclick="editarServo(${s.id},'${s.nome}','${s.ministerio}','${s.telefone||''}')">‚úèÔ∏è</button></div>`)}
        async function editarServo(id,n,m,t){ const nn=prompt("Nome:",n); if(nn===null) return; const nm=prompt("Min:",m); if(nm===null) return; const nt=prompt("WhatsApp:",t); if(nt===null) return; const s=prompt("Senha:");if(!s)return; await fetch(`/servos/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({nome:nn,ministerio:nm,telefone:nt,senha:s})}); carregarDadosIniciais(); toast("Atualizado!"); }
        function filtrarListaPorMinisterio(){const m=document.getElementById('selectMinisterio').value;const c=document.getElementById('containerChecklist');c.innerHTML="";if(!m)return;const l=todosServos.filter(s=>m==="Geral"?true:s.ministerio&&s.ministerio.includes(m));if(l.length===0)c.innerHTML="<p style='text-align:center'>Vazio</p>";l.forEach(s=>{c.innerHTML+=`<div class="checklist-item"><label style='display:flex;width:100%'><input type='checkbox' value='${s.id}' class='chk-servo'><span style='flex:1'>${s.nome}</span><small>(${s.ministerio})</small></label></div>`})}
        function marcarTodos(b){document.querySelectorAll('.chk-servo').forEach(c=>c.checked=b)}
        document.getElementById('formEscala').onsubmit=async(e)=>{e.preventDefault();const i=Array.from(document.querySelectorAll('.chk-servo:checked')).map(c=>c.value);if(i.length===0)return toast("Selecione algu√©m!","erro");const s=prompt("üîí Senha:");if(!s)return;setLoading('btnSalvarEscala',true);const r=await fetch('/escalar-multiplo',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({servo_ids:i,data:document.getElementById('dataEscala').value,ministerio_nome:document.getElementById('selectMinisterio').value,responsavel:document.getElementById('inputResponsavel').value,senha:s})});const j=await r.json();setLoading('btnSalvarEscala',false,"Confirmar Escala");if(r.ok){toast(j.mensagem);carregarEscalaDoDia();marcarTodos(false);}else toast(j.erro,"erro");}
        async function delEscala(id){const s=prompt("Senha:");if(!s)return;const r=await fetch(`/escalas/${id}`,{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({senha:s})});if(r.ok){carregarEscalaDoDia();toast("Exclu√≠do!");}else toast("Erro","erro");}
        function gerarImagem(){const a=document.getElementById('areaParaImagem');document.querySelectorAll('.btn-acao,.btn-zap').forEach(b=>b.style.display='none');html2canvas(a).then(c=>{const l=document.createElement('a');l.download='escala.jpg';l.href=c.toDataURL();l.click();document.querySelectorAll('.btn-acao,.btn-zap').forEach(b=>b.style.display='inline-flex');toast("Imagem baixada!");})}
        async function carregarEventosDoMes() { try { const res = await fetch('/eventos'); eventosMes = await res.json(); renderizarCalendario(); } catch(e) {} }
        function renderizarCalendario() { const grid = document.getElementById('calendarioGrid'); grid.innerHTML = ""; const ano = dataCalendario.getFullYear(); const mes = dataCalendario.getMonth(); const meses = ["JANEIRO","FEVEREIRO","MAR√áO","ABRIL","MAIO","JUNHO","JULHO","AGOSTO","SETEMBRO","OUTUBRO","NOVEMBRO","DEZEMBRO"]; document.getElementById('mesAnoDisplay').innerText = `${meses[mes]} ${ano}`; const primeiroDia = new Date(ano, mes, 1).getDay(); const ultimoDia = new Date(ano, mes + 1, 0).getDate(); for(let i=0; i<primeiroDia; i++) grid.innerHTML += `<div style="background:#EEE"></div>`; const hoje = new Date().toISOString().split('T')[0]; for(let dia=1; dia<=ultimoDia; dia++) { const dataFmt = `${ano}-${String(mes+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`; const salvos = eventosMes.filter(e => e.data === dataFmt); const pendentes = filaPendentes.filter(e => e.data === dataFmt); let html = ""; salvos.forEach(ev => html += `<div class="evento-chip">${ev.titulo}</div>`); pendentes.forEach(ev => html += `<div class="evento-chip pendente">‚è≥ ${ev.titulo}</div>`); const cls = dataFmt === hoje ? 'dia-cal hoje' : 'dia-cal'; const div = document.createElement('div'); div.className = cls; div.innerHTML = `<span class="dia-numero">${dia}</span>${html}`; div.onclick = () => abrirModalEvento(dataFmt); grid.appendChild(div); } }
        function mudarMes(d) { dataCalendario.setMonth(dataCalendario.getMonth()+d); carregarEventosDoMes(); }
        function gerarPDFCalendario() { const btn = document.getElementById('btnBaixarPDF'); setLoading('btnBaixarPDF', true, "Gerando PDF..."); const elemento = document.getElementById('areaCalendarioPDF'); const logo = document.getElementById('logoPdfHeader'); const botoes = document.querySelectorAll('.esconder-na-foto'); logo.style.display = 'block'; botoes.forEach(b => b.style.display = 'none'); const opt = { margin: 5, filename: `Calendario_${document.getElementById('mesAnoDisplay').innerText}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } }; setTimeout(() => { html2pdf().set(opt).from(elemento).save().then(() => { logo.style.display = 'none'; botoes.forEach(b => b.style.display = 'inline-block'); setLoading('btnBaixarPDF', false, "üìÑ Baixar Calend√°rio (PDF A4)"); toast("PDF gerado!"); }).catch(err => { toast("Erro no PDF", "erro"); setLoading('btnBaixarPDF', false, "üìÑ Baixar Calend√°rio (PDF A4)"); }); }, 200); }
        function abrirModalEvento(d) { document.getElementById('modalEvento').style.display='block'; document.getElementById('evDataInicio').value = d; document.getElementById('evDataFim').value = ""; document.getElementById('evTitulo').value = ""; const div = document.getElementById('listaEventosDia'); div.innerHTML = "<h4>Neste dia:</h4>"; const salvos = eventosMes.filter(e => e.data === d); salvos.forEach(ev => div.innerHTML += `<div style="padding:5px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between"><span>${ev.titulo}</span><button onclick="apagarEvento(${ev.id})" style="color:red;border:none;cursor:pointer">üóëÔ∏è</button></div>`); const pends = filaPendentes.filter(e => e.data === d); pends.forEach((ev, idx) => div.innerHTML += `<div style="padding:5px;background:#FFF9C4;display:flex;justify-content:space-between"><span>‚è≥ ${ev.titulo}</span><small>Pendente</small></div>`); }
        function fecharModalEvento() { document.getElementById('modalEvento').style.display='none'; }
        function adicionarAFila() { const tit = document.getElementById('evTitulo').value; const ini = document.getElementById('evDataInicio').value; const fim = document.getElementById('evDataFim').value; const min = document.getElementById('evMinisterio').value; if(!tit) return toast("Digite o t√≠tulo!", "erro"); let tituloFinal = tit; if(min !== 'Geral') tituloFinal = `${tit} - ${min}`; let atual = new Date(ini); atual.setMinutes(atual.getMinutes()+atual.getTimezoneOffset()); let limite = fim ? new Date(fim) : new Date(ini); limite.setMinutes(limite.getMinutes()+limite.getTimezoneOffset()); if(limite < atual) return toast("Data final menor que in√≠cio", "erro"); while(atual <= limite) { filaPendentes.push({ titulo: tituloFinal, data: atual.toISOString().split('T')[0], ministerio: min }); atual.setDate(atual.getDate()+1); } fecharModalEvento(); renderizarCalendario(); atualizarBarraSalvar(); toast("Na lista de espera!"); }
        function atualizarBarraSalvar() { const barra = document.getElementById('barraSalvar'); if(filaPendentes.length > 0) { barra.style.display = 'flex'; document.getElementById('txtPendentes').innerText = `${filaPendentes.length} altera√ß√µes`; } else { barra.style.display = 'none'; } }
        async function processarFila() { if(filaPendentes.length === 0) return; const senha = prompt(`Salvar ${filaPendentes.length} eventos?\nüîí Digite a Senha:`); if(!senha) return; setLoading('btnSalvarFila', true); let erros = 0; for(const ev of filaPendentes) { const res = await fetch('/eventos', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ...ev, senha }) }); if(!res.ok) erros++; } setLoading('btnSalvarFila', false, "üíæ SALVAR TUDO"); if(erros > 0) toast(`${erros} falhas.`, "erro"); else toast("Tudo salvo!"); filaPendentes = []; atualizarBarraSalvar(); carregarEventosDoMes(); }
        async function apagarEvento(id) { if(!confirm("Apagar?")) return; const senha = prompt("üîí Senha:"); if(!senha) return; const r = await fetch(`/eventos/${id}`, {method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({senha})}); if(r.ok) { const d=document.getElementById('evDataInicio').value; carregarEventosDoMes(); setTimeout(()=>abrirModalEvento(d),500); toast("Apagado!"); } else toast("Erro", "erro"); }

        window.onload = () => { carregarDadosIniciais(); };
    </script>
</body>
</html>