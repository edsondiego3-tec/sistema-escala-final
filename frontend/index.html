<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jacozinho do Senhor - Escalas</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --cor-primaria: #5D4037; --cor-secundaria: #8D6E63;
            --cor-fundo: #EFEBE9; --cor-texto: #3E2723;
            --cor-branco: #FFFFFF; --cor-sucesso: #2E7D32; --cor-aviso: #FF9800;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--cor-fundo); color: var(--cor-texto); display: flex; justify-content: center; min-height: 100vh; padding-bottom: 50px;}
        .app-container { background: var(--cor-branco); width: 100%; max-width: 450px; box-shadow: 0 4px 20px rgba(93,64,55,0.15); min-height: 100vh; display: flex; flex-direction: column; }
        
        header { background: white; padding: 20px; text-align: center; border-bottom: 4px solid var(--cor-primaria); }
        .logo-img { max-width: 180px; display: block; margin: 0 auto 10px auto; }
        header h1 { font-size: 1.4rem; font-weight: 700; color: var(--cor-primaria); text-transform: uppercase; }
        
        main { padding: 20px; flex-grow: 1; }
        label { font-size: 0.8rem; color: var(--cor-secundaria); font-weight: 700; margin-bottom: 5px; display: block; text-transform: uppercase; margin-top: 15px;}
        input, select { width: 100%; padding: 12px; border: 2px solid #D7CCC8; border-radius: 8px; font-size: 1rem; color: var(--cor-texto); background: #fff;}
        
        .btn-salvar { width: 100%; padding: 15px; background-color: var(--cor-primaria); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 20px; font-size: 1rem; }
        .btn-mini { padding: 6px 12px; font-size: 0.8rem; background: #D7CCC8; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        
        /* BOT√ïES DE TOPO */
        .top-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-novo-servo { flex: 1; background: transparent; border: 2px solid var(--cor-primaria); color: var(--cor-primaria); padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-gerenciar { flex: 1; background: #EEE; border: 2px solid #BBB; color: #555; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* √ÅREAS ESCONDIDAS (MODAIS) */
        .area-modal { display: none; background: #FFF8E1; padding: 15px; border: 2px dashed var(--cor-secundaria); border-radius: 10px; margin-bottom: 20px; }
        
        /* LISTA DE CHECKBOX */
        .checklist-container { border: 2px solid #D7CCC8; border-radius: 8px; max-height: 250px; overflow-y: auto; padding: 10px; background: #FAFAFA; }
        .checklist-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .checklist-item input { margin-right: 10px; width: 18px; height: 18px; accent-color: var(--cor-primaria); }

        /* LISTA DE GERENCIAMENTO */
        .item-gerencia { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #ddd; background: white; }
        .item-gerencia div { font-size: 0.9rem; }
        .btn-acao { border: none; background: none; font-size: 1.2rem; cursor: pointer; margin-left: 10px; }

        /* RESULTADO DA ESCALA */
        #areaParaImagem { background: white; padding: 15px; border-radius: 10px; margin-top: 30px; border: 1px solid #eee; }
        .card-escala { background: #F5F5F5; border-radius: 8px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; border-left: 5px solid var(--cor-primaria); }
        .card-nome { font-weight: 700; color: var(--cor-primaria); }
        .card-min { font-size: 0.85rem; color: #757575; }
        .cabecalho-imagem { display: none; text-align: center; margin-bottom: 15px; border-bottom: 2px solid var(--cor-primaria); }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <img src="logo.png" class="logo-img">
            <h1>Escala dos Servos</h1>
        </header>

        <main>
            <div class="top-buttons">
                <button onclick="toggleArea('areaCadastro')" class="btn-novo-servo">‚ûï Novo Servo</button>
                <button onclick="toggleArea('areaGerenciar'); carregarParaGerenciar()" class="btn-gerenciar">‚öôÔ∏è Gerenciar</button>
            </div>
            
            <div id="areaCadastro" class="area-modal">
                <h3 style="color:var(--cor-primaria);">Novo Cadastro</h3>
                <input type="text" id="novoNome" placeholder="Nome Completo" style="margin:10px 0;">
                <select id="novoMinisterio">
                    <option value="">Selecione...</option>
                    <option value="M√∫sica">M√∫sica</option>
                    <option value="Comunica√ß√£o">Comunica√ß√£o</option>
                    <option value="Acolhida">Acolhida</option>
                    <option value="Prega√ß√£o">Prega√ß√£o</option>
                    <option value="Intercess√£o">Intercess√£o</option>
                    <option value="Crian√ßas">Crian√ßas</option>
                    <option value="Coordena√ß√£o">Coordena√ß√£o</option>
                    <option value="Promo√ß√£o Humana">Promo√ß√£o Humana</option>
                    <option value="Jovem">Jovem</option>
                    <option value="Forma√ß√£o">Forma√ß√£o</option>
                    <option value="Fam√≠lias">Fam√≠lias</option>
                </select>
                <button onclick="salvarNovoServo()" class="btn-salvar" style="margin-top:10px; background:var(--cor-secundaria)">Salvar</button>
            </div>

            <div id="areaGerenciar" class="area-modal" style="background:#ECEFF1; border-color:#90A4AE;">
                <h3 style="color:#455A64;">Gerenciar Equipe</h3>
                <input type="text" id="buscaGerencia" placeholder="üîç Buscar nome..." onkeyup="filtrarGerencia()" style="margin:10px 0;">
                <div id="listaGerencia" style="max-height: 200px; overflow-y: auto;">Carregando...</div>
                <button onclick="toggleArea('areaGerenciar')" class="btn-salvar" style="background:#90A4AE; margin-top:10px">Fechar</button>
            </div>

            <hr style="margin: 20px 0; border:0; border-top:1px solid #ddd">

            <form id="formEscala">
                <label>üñäÔ∏è Respons√°vel:</label>
                <input type="text" id="inputResponsavel" placeholder="Seu nome..." required>

                <label>üìÖ Data:</label>
                <input type="date" id="dataEscala" required onchange="carregarEscalaDoDia()">

                <label>üõ†Ô∏è Filtrar Fun√ß√£o:</label>
                <select id="selectMinisterio" required onchange="filtrarListaPorMinisterio()">
                    <option value="">Selecione...</option>
                    <option value="Geral">Todos</option>
                    <option value="M√∫sica">M√∫sica</option>
                    <option value="Comunica√ß√£o">Comunica√ß√£o</option>
                    <option value="Acolhida">Acolhida</option>
                    <option value="Prega√ß√£o">Prega√ß√£o</option>
                    <option value="Intercess√£o">Intercess√£o</option>
                    <option value="Crian√ßas">Crian√ßas</option>
                    <option value="Coordena√ß√£o">Coordena√ß√£o</option>
                    <option value="Promo√ß√£o Humana">Promo√ß√£o Humana</option>
                    <option value="Jovem">Jovem</option>
                    <option value="Forma√ß√£o">Forma√ß√£o</option>
                    <option value="Fam√≠lias">Fam√≠lias</option>
                </select>

                <div class="checklist-container" id="containerChecklist" style="margin-top:10px">
                    <p style="text-align:center; color:#999; padding:20px;">Selecione uma fun√ß√£o.</p>
                </div>

                <div style="display:flex; gap:10px; margin-top:5px">
                    <button type="button" class="btn-mini" onclick="marcarTodos(true)">Todos</button>
                    <button type="button" class="btn-mini" onclick="marcarTodos(false)">Nenhum</button>
                </div>

                <button type="submit" class="btn-salvar">Confirmar Escala</button>
            </form>

            <div id="areaParaImagem">
                <div class="cabecalho-imagem">
                    <h3 style="color:var(--cor-primaria)">ESCALA DO DIA</h3>
                    <h4 id="dataTitulo" style="color:#666">--/--/----</h4>
                </div>
                <div id="listaEscalados"></div>
            </div>

            <button onclick="gerarImagem()" class="btn-salvar" style="background:var(--cor-sucesso)">üì∏ Baixar Imagem</button>
        </main>
    </div>

    <script>
        let todosServos = []; 

        async function carregarDadosIniciais() {
            try {
                const res = await fetch('/servos');
                todosServos = await res.json();
            } catch (e) { console.error(e); }
        }

        function toggleArea(id) {
            const el = document.getElementById(id);
            document.querySelectorAll('.area-modal').forEach(d => { if(d.id !== id) d.style.display = 'none'; });
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }

        // --- GERENCIAMENTO ---
        function carregarParaGerenciar() {
            const div = document.getElementById('listaGerencia');
            div.innerHTML = "";
            todosServos.forEach(s => {
                div.innerHTML += `
                    <div class="item-gerencia" data-nome="${s.nome.toLowerCase()}">
                        <div><b>${s.nome}</b><br><small>${s.ministerio}</small></div>
                        <div>
                            <button class="btn-acao" onclick="editarServo(${s.id}, '${s.nome}', '${s.ministerio}')">‚úèÔ∏è</button>
                            <button class="btn-acao" onclick="excluirServo(${s.id})" style="color:red">üóëÔ∏è</button>
                        </div>
                    </div>`;
            });
        }

        function filtrarGerencia() {
            const termo = document.getElementById('buscaGerencia').value.toLowerCase();
            document.querySelectorAll('.item-gerencia').forEach(div => {
                div.style.display = div.getAttribute('data-nome').includes(termo) ? 'flex' : 'none';
            });
        }

        async function editarServo(id, nomeAtual, minAtual) {
            const novoNome = prompt("Novo Nome:", nomeAtual);
            if(novoNome === null) return;
            const novoMin = prompt("Novo Minist√©rio (Ex: M√∫sica, Acolhida):", minAtual);
            if(novoMin === null) return;
            const senha = prompt("üîí Senha para alterar:");
            if(!senha) return;

            try {
                const res = await fetch(`/servos/${id}`, {
                    method: 'PUT', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ nome: novoNome, ministerio: novoMin, senha })
                });
                const json = await res.json();
                alert(res.ok ? "‚úÖ Atualizado!" : "‚ùå " + json.erro);
                if(res.ok) { carregarDadosIniciais().then(carregarParaGerenciar); }
            } catch(e) { alert("Erro conex√£o"); }
        }

        async function excluirServo(id) {
            if(!confirm("Tem certeza? Isso apaga o servo para sempre.")) return;
            const senha = prompt("üîí Senha para excluir do banco:");
            if(!senha) return;

            try {
                const res = await fetch(`/servos-cadastro/${id}`, {
                    method: 'DELETE', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ senha })
                });
                const json = await res.json();
                alert(res.ok ? "‚úÖ Removido!" : "‚ùå " + json.erro);
                if(res.ok) { carregarDadosIniciais().then(carregarParaGerenciar); }
            } catch(e) { alert("Erro conex√£o"); }
        }

        // --- CADASTRO ---
        async function salvarNovoServo() {
            const nome = document.getElementById('novoNome').value;
            const min = document.getElementById('novoMinisterio').value;
            if(!nome || !min) { alert("Preencha tudo!"); return; }

            await fetch('/servos', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ nome, ministerio: min })
            });
            alert("‚úÖ Cadastrado!");
            document.getElementById('novoNome').value = "";
            toggleArea('areaCadastro');
            carregarDadosIniciais();
        }

        // --- FILTRO INTELIGENTE (PULO DO GATO üê±) ---
        function filtrarListaPorMinisterio() {
            const min = document.getElementById('selectMinisterio').value;
            const container = document.getElementById('containerChecklist');
            container.innerHTML = "";
            
            if(!min) {
                container.innerHTML = "<p style='padding:10px; text-align:center'>Selecione um minist√©rio...</p>";
                return;
            }

            // AQUI EST√Å A M√ÅGICA DO "INCLUDES"
            const lista = todosServos.filter(s => {
                if (min === "Geral") return true;
                return s.ministerio && s.ministerio.includes(min);
            });

            if(lista.length === 0) {
                container.innerHTML = "<p style='padding:10px;text-align:center;color:red'>Ningu√©m encontrado.</p>";
                return;
            }

            lista.forEach(s => {
                container.innerHTML += `
                    <div class="checklist-item">
                        <label style="display:flex; align-items:center; width:100%; cursor:pointer">
                            <input type="checkbox" value="${s.id}" class="chk-servo">
                            <span style="flex-grow:1; margin-left:10px">${s.nome}</span>
                            <small style="color:#999">(${s.ministerio})</small>
                        </label>
                    </div>`;
            });
        }

        function marcarTodos(ok) { document.querySelectorAll('.chk-servo').forEach(c => c.checked = ok); }

        // --- SALVAR ESCALA ---
        document.getElementById('formEscala').onsubmit = async (e) => {
            e.preventDefault();
            const ids = Array.from(document.querySelectorAll('.chk-servo:checked')).map(c => c.value);
            if(ids.length === 0) { alert("Selecione algu√©m!"); return; }
            const senha = prompt("üîí Senha do Coordenador:");
            if(!senha) return;

            const res = await fetch('/escalar-multiplo', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ 
                    servo_ids: ids, 
                    data: document.getElementById('dataEscala').value,
                    ministerio_nome: document.getElementById('selectMinisterio').value,
                    responsavel: document.getElementById('inputResponsavel').value,
                    senha 
                })
            });
            const json = await res.json();
            alert(res.ok ? "‚úÖ " + json.mensagem : "‚ùå " + json.erro);
            if(res.ok) { carregarEscalaDoDia(); marcarTodos(false); }
        };

        async function carregarEscalaDoDia() {
            const data = document.getElementById('dataEscala').value;
            if(!data) return;
            document.getElementById('dataTitulo').innerText = data.split('-').reverse().join('/');
            
            const div = document.getElementById('listaEscalados');
            div.innerHTML = "Carregando...";
            const res = await fetch(`/escalas/${data}`);
            const lista = await res.json();
            div.innerHTML = "";

            if(lista.length === 0) { div.innerHTML = "<p style='text-align:center;color:#999'>Vazio.</p>"; return; }

            lista.forEach(item => {
                div.innerHTML += `
                    <div class="card-escala">
                        <div><div class="card-nome">${item.servos?.nome}</div><div class="card-min">${item.ministerio_nome}</div></div>
                        <button class="btn-delete" onclick="deletarEscala(${item.id})">‚ùå</button>
                    </div>`;
            });
        }

        async function deletarEscala(id) {
            const senha = prompt("üîí Senha para excluir:");
            if(!senha) return;
            const res = await fetch(`/escalas/${id}`, {
                method: 'DELETE', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ senha })
            });
            if(res.ok) carregarEscalaDoDia();
            else alert("‚ùå Senha incorreta!");
        }

        function gerarImagem() {
            const area = document.getElementById('areaParaImagem');
            document.querySelectorAll('.btn-delete').forEach(b => b.style.display = 'none');
            document.querySelector('.cabecalho-imagem').style.display = 'block';
            
            html2canvas(area).then(c => {
                const a = document.createElement('a');
                a.download = 'escala.jpg'; a.href = c.toDataURL("image/jpeg"); a.click();
                document.querySelectorAll('.btn-delete').forEach(b => b.style.display = 'block');
                document.querySelector('.cabecalho-imagem').style.display = 'none';
            });
        }

        window.onload = carregarDadosIniciais;
    </script>
</body>
</html>