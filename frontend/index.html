<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jacozinho do Senhor</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --cor-primaria: #5D4037; --cor-secundaria: #8D6E63;
            --cor-fundo: #EFEBE9; --cor-texto: #3E2723;
            --cor-branco: #FFFFFF; --cor-sucesso: #2E7D32;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--cor-fundo); color: var(--cor-texto); display: flex; justify-content: center; min-height: 100vh; padding-bottom: 50px;}
        .app-container { background: var(--cor-branco); width: 100%; max-width: 800px; /* Aumentei um pouco para caber melhor na tela */ box-shadow: 0 4px 20px rgba(93,64,55,0.15); min-height: 100vh; display: flex; flex-direction: column; }
        
        header { background: white; padding: 15px; text-align: center; border-bottom: 4px solid var(--cor-primaria); }
        .logo-img { max-width: 150px; display: block; margin: 0 auto 5px auto; }
        
        /* ABAS */
        .abas { display: flex; background: #D7CCC8; }
        .aba { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; color: #5D4037; border-bottom: 3px solid transparent; }
        .aba.ativa { background: white; border-bottom: 3px solid var(--cor-primaria); color: var(--cor-primaria); }
        
        main { padding: 20px; flex-grow: 1; }
        .view-section { display: none; }
        .view-section.ativa { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

        /* INPUTS E BOT√ïES */
        label { font-size: 0.8rem; color: var(--cor-secundaria); font-weight: 700; margin-bottom: 5px; display: block; text-transform: uppercase; margin-top: 15px;}
        input, select { width: 100%; padding: 12px; border: 2px solid #D7CCC8; border-radius: 8px; font-size: 1rem; margin-bottom: 5px; background: #fff;}
        .btn-salvar { width: 100%; padding: 15px; background-color: var(--cor-primaria); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 20px; font-size: 1rem; }
        .btn-mini { padding: 6px 12px; font-size: 0.8rem; background: #D7CCC8; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        
        /* --- CALEND√ÅRIO --- */
        /* Estilo espec√≠fico para o PDF ficar bonito */
        #areaCalendarioPDF {
            background: white;
            padding: 10px;
            color: #000; /* Garante preto puro para impress√£o */
        }

        .calendario-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: var(--cor-primaria); color: white; padding: 15px; border-radius: 8px 8px 0 0; }
        
        .grid-dias { 
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; 
            text-align: center; font-weight: bold; margin-bottom: 0; 
            color: var(--cor-branco); background: var(--cor-secundaria); padding: 8px 0; font-size: 0.9rem;
        }
        
        .grid-calendario { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            grid-auto-rows: 120px; /* Altura fixa boa para A4 */
            gap: 2px; 
            background: #D7CCC8; 
            border: 2px solid var(--cor-secundaria); 
        }
        
        .dia-cal { 
            background: #FFF; 
            padding: 4px; 
            cursor: pointer; 
            position: relative; 
            font-size: 0.85rem; 
            display: flex; 
            flex-direction: column;
            overflow: hidden; 
        }
        .dia-cal:hover { background: #FAFAFA; overflow-y: auto; }
        .dia-cal.hoje { background: #E0F2F1; }
        .dia-numero { font-weight: bold; display: block; margin-bottom: 4px; color: var(--cor-primaria); font-size: 1rem;}
        
        .evento-chip { 
            font-size: 0.7rem; background: var(--cor-primaria); color: white; 
            padding: 3px 5px; border-radius: 4px; margin-bottom: 2px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            width: 100%; display: block;
        }

        /* MODAIS */
        .area-modal { display: none; background: #FFF8E1; padding: 15px; border: 2px dashed var(--cor-secundaria); border-radius: 10px; margin-bottom: 20px; }
        .checklist-container { border: 2px solid #D7CCC8; border-radius: 8px; max-height: 250px; overflow-y: auto; padding: 10px; background: #FAFAFA; }
        .checklist-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .checklist-item input { margin-right: 10px; width: 18px; height: 18px; accent-color: var(--cor-primaria); }
        .card-escala { background: #F5F5F5; border-radius: 8px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; border-left: 5px solid var(--cor-primaria); }
        .btn-acao { border: none; background: none; font-size: 1.2rem; cursor: pointer; }
        .esconder-na-foto { display: inline-block; }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <img src="logo.png" class="logo-img">
            <div class="abas">
                <div class="aba ativa" onclick="mudarAba('tab-escala', this)">üìã ESCALAS</div>
                <div class="aba" onclick="mudarAba('tab-calendario', this)">üìÖ CALEND√ÅRIO</div>
            </div>
        </header>

        <main>
            <div id="tab-escala" class="view-section ativa">
                <div style="display:flex; gap:10px; margin-bottom:15px">
                    <button onclick="toggleArea('areaCadastro')" class="btn-mini" style="flex:1">‚ûï Novo Servo</button>
                    <button onclick="toggleArea('areaGerenciar'); carregarParaGerenciar()" class="btn-mini" style="flex:1">‚öôÔ∏è Gerenciar</button>
                </div>

                <div id="areaCadastro" class="area-modal">
                    <h3>Novo Cadastro</h3>
                    <input type="text" id="novoNome" placeholder="Nome">
                    <select id="novoMinisterio"><option value="M√∫sica">M√∫sica</option><option value="Acolhida">Acolhida</option><option value="Prega√ß√£o">Prega√ß√£o</option><option value="Intercess√£o">Intercess√£o</option><option value="Outros">Outros</option></select>
                    <button onclick="salvarNovoServo()" class="btn-mini">Salvar</button>
                </div>
                <div id="areaGerenciar" class="area-modal">
                    <h3>Gerenciar</h3>
                    <input type="text" id="buscaGerencia" placeholder="Buscar..." onkeyup="filtrarGerencia()">
                    <div id="listaGerencia" style="max-height:150px;overflow-y:auto"></div>
                </div>

                <form id="formEscala">
                    <label>Respons√°vel:</label> <input type="text" id="inputResponsavel" required>
                    <label>Data:</label> <input type="date" id="dataEscala" required onchange="carregarEscalaDoDia()">
                    <label>Minist√©rio:</label> 
                    <select id="selectMinisterio" required onchange="filtrarListaPorMinisterio()">
                        <option value="">Selecione...</option>
                        <option value="Geral">Todos</option>
                        <option value="M√∫sica">M√∫sica</option>
                        <option value="Comunica√ß√£o">Comunica√ß√£o</option>
                        <option value="Acolhida">Acolhida</option>
                        <option value="Prega√ß√£o">Prega√ß√£o</option>
                        <option value="Intercess√£o">Intercess√£o</option>
                        <option value="Crian√ßas">Crian√ßas</option>
                        <option value="Coordena√ß√£o">Coordena√ß√£o</option>
                        <option value="Promo√ß√£o Humana">Promo√ß√£o Humana</option>
                        <option value="Jovem">Jovem</option>
                        <option value="Forma√ß√£o">Forma√ß√£o</option>
                        <option value="Fam√≠lias">Fam√≠lias</option>
                    </select>

                    <div class="checklist-container" id="containerChecklist"><p style="text-align:center;color:#999;padding:10px">Selecione fun√ß√£o...</p></div>
                    <div style="margin-top:5px"><button type="button" class="btn-mini" onclick="marcarTodos(true)">Todos</button> <button type="button" class="btn-mini" onclick="marcarTodos(false)">Nenhum</button></div>
                    <button type="submit" class="btn-salvar">Salvar Escala</button>
                </form>

                <div id="areaParaImagem" style="background:white;padding:10px;margin-top:20px;border:1px solid #eee;border-radius:8px">
                    <h3 style="text-align:center;color:#5D4037;border-bottom:2px solid #5D4037;margin-bottom:10px">ESCALA DO DIA <span id="dataTitulo">--/--</span></h3>
                    <div id="listaEscalados"></div>
                </div>
                <button onclick="gerarImagem()" class="btn-salvar" style="background:var(--cor-sucesso);margin-top:10px">üì∏ Baixar Escala (JPG)</button>
            </div>

            <div id="tab-calendario" class="view-section">
                
                <div id="areaCalendarioPDF">
                    <div class="calendario-header">
                        <button class="btn-mini esconder-na-foto" onclick="mudarMes(-1)">‚óÄ</button>
                        <h2 id="mesAnoDisplay" style="margin:0; text-transform:uppercase; letter-spacing:2px; font-size:1.5rem">M√™s / Ano</h2>
                        <button class="btn-mini esconder-na-foto" onclick="mudarMes(1)">‚ñ∂</button>
                    </div>

                    <div class="grid-dias">
                        <div>DOMINGO</div><div>SEGUNDA</div><div>TER√áA</div><div>QUARTA</div><div>QUINTA</div><div>SEXTA</div><div>S√ÅBADO</div>
                    </div>
                    <div id="calendarioGrid" class="grid-calendario"></div>
                </div>
                
                <button onclick="gerarPDFCalendario()" class="btn-salvar" style="background:#D32F2F; margin-top:10px">üìÑ Baixar Calend√°rio (PDF A4)</button>

                <div id="modalEvento" class="area-modal" style="margin-top:20px">
                    <h3>Novo Compromisso</h3>
                    
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1"><label>In√≠cio:</label><input type="date" id="evDataInicio" readonly style="background:#EEE"></div>
                        <div style="flex:1"><label>Final (Opcional):</label><input type="date" id="evDataFim"></div>
                    </div>
                    <small style="color:#666; display:block; margin-bottom:10px">Se preencher a data final, o evento repetir√° todos os dias.</small>

                    <label>T√≠tulo:</label>
                    <input type="text" id="evTitulo" list="sugestoesTitulos" placeholder="Digite ou selecione...">
                    <datalist id="sugestoesTitulos">
                        <option value="SANTA MISSA">
                        <option value="REUNI√ÉO">
                        <option value="RETIRO">
                        <option value="FORMA√á√ÉO DE SERVOS">
                        <option value="GRUPO DE ORA√á√ÉO">
                        <option value="ADORA√á√ÉO">
                        <option value="VIG√çLIA">
                    </datalist>
                    
                    <label>Minist√©rio Respons√°vel:</label>
                    <select id="evMinisterio">
                        <option value="Geral">Geral (Todos)</option>
                        <option value="M√∫sica">M√∫sica</option>
                        <option value="Comunica√ß√£o">Comunica√ß√£o</option>
                        <option value="Acolhida">Acolhida</option>
                        <option value="Prega√ß√£o">Prega√ß√£o</option>
                        <option value="Intercess√£o">Intercess√£o</option>
                        <option value="Crian√ßas">Crian√ßas</option>
                        <option value="Coordena√ß√£o">Coordena√ß√£o</option>
                        <option value="Promo√ß√£o Humana">Promo√ß√£o Humana</option>
                        <option value="Jovem">Jovem</option>
                        <option value="Forma√ß√£o">Forma√ß√£o</option>
                        <option value="Fam√≠lias">Fam√≠lias</option>
                    </select>

                    <div style="display:flex;gap:10px;margin-top:15px"><button onclick="fecharModalEvento()" class="btn-mini" style="background:#999;flex:1">Cancelar</button><button onclick="salvarEvento()" class="btn-mini" style="background:var(--cor-primaria);color:white;flex:1">Salvar</button></div>
                </div>
                <div id="listaEventosDia" style="margin-top:20px"></div>
            </div>
        </main>
    </div>

    <script>
        let todosServos = [];
        let eventosMes = [];
        let dataCalendario = new Date();

        function mudarAba(idAlvo, abaElemento) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('ativa'));
            document.getElementById(idAlvo).classList.add('ativa');
            document.querySelectorAll('.aba').forEach(a => a.classList.remove('ativa'));
            abaElemento.classList.add('ativa');
            if(idAlvo === 'tab-calendario') carregarEventosDoMes();
        }

        function toggleArea(id) { const el = document.getElementById(id); el.style.display = el.style.display==='block'?'none':'block'; }

        async function carregarEventosDoMes() {
            try {
                const res = await fetch('/eventos');
                eventosMes = await res.json();
                renderizarCalendario();
            } catch(e) { }
        }

        function renderizarCalendario() {
            const grid = document.getElementById('calendarioGrid');
            grid.innerHTML = "";
            const ano = dataCalendario.getFullYear();
            const mes = dataCalendario.getMonth();
            const meses = ["JANEIRO","FEVEREIRO","MAR√áO","ABRIL","MAIO","JUNHO","JULHO","AGOSTO","SETEMBRO","OUTUBRO","NOVEMBRO","DEZEMBRO"];
            document.getElementById('mesAnoDisplay').innerText = `${meses[mes]} ${ano}`;

            const primeiroDiaSemana = new Date(ano, mes, 1).getDay();
            const ultimoDiaMes = new Date(ano, mes + 1, 0).getDate();

            // C√©lulas vazias antes do dia 1
            for(let i=0; i<primeiroDiaSemana; i++) grid.innerHTML += `<div style="background:#EEE"></div>`;

            const hojeStr = new Date().toISOString().split('T')[0];
            
            for(let dia=1; dia<=ultimoDiaMes; dia++) {
                const dataFmt = `${ano}-${String(mes+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;
                const evsDia = eventosMes.filter(e => e.data === dataFmt);
                
                let htmlEvs = "";
                evsDia.forEach(ev => { 
                    htmlEvs += `<div class="evento-chip">${ev.titulo}</div>`; 
                });

                const ehHoje = dataFmt === hojeStr ? 'hoje' : '';
                const div = document.createElement('div');
                div.className = `dia-cal ${ehHoje}`;
                div.innerHTML = `<span class="dia-numero">${dia}</span>${htmlEvs}`;
                div.onclick = () => abrirModalEvento(dataFmt);
                grid.appendChild(div);
            }
        }

        function mudarMes(delta) {
            dataCalendario.setMonth(dataCalendario.getMonth() + delta);
            carregarEventosDoMes();
        }

        // --- FUN√á√ÉO DE GERAR PDF (NOVA) ---
        function gerarPDFCalendario() {
            const elemento = document.getElementById('areaCalendarioPDF');
            
            // Esconde bot√µes na hora do PDF
            document.querySelectorAll('.esconder-na-foto').forEach(b => b.style.display = 'none');
            
            // Configura√ß√µes do PDF (A4, Paisagem)
            const opt = {
                margin:       5,
                filename:     `Calendario_${document.getElementById('mesAnoDisplay').innerText}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 }, // Melhora a qualidade
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };

            // Gera e Baixa
            html2pdf().set(opt).from(elemento).save().then(() => {
                // Mostra bot√µes de volta
                document.querySelectorAll('.esconder-na-foto').forEach(b => b.style.display = 'inline-block');
            });
        }

        function abrirModalEvento(dataStr) {
            document.getElementById('modalEvento').style.display = 'block';
            document.getElementById('evDataInicio').value = dataStr;
            document.getElementById('evDataFim').value = ""; 
            document.getElementById('evTitulo').value = "";
            
            const divLista = document.getElementById('listaEventosDia');
            divLista.innerHTML = "<h4>Agenda do dia:</h4>";
            const evs = eventosMes.filter(e => e.data === dataStr);
            if(evs.length === 0) divLista.innerHTML += "<p><small>Nada marcado.</small></p>";
            evs.forEach(ev => {
                divLista.innerHTML += `
                <div style="background:#FFF; padding:8px; margin-bottom:5px; border-radius:5px; border-left:4px solid var(--cor-primaria); display:flex; justify-content:space-between; align-items:center">
                    <div><b>${ev.titulo}</b><br><small>${ev.ministerio}</small></div>
                    <button onclick="apagarEvento(${ev.id})" style="color:red;border:none;background:none;cursor:pointer;font-size:1.2rem">üóëÔ∏è</button>
                </div>`;
            });
        }
        function fecharModalEvento() { document.getElementById('modalEvento').style.display = 'none'; }

        async function salvarEvento() {
            const tituloOriginal = document.getElementById('evTitulo').value;
            const dataInicio = document.getElementById('evDataInicio').value;
            const dataFim = document.getElementById('evDataFim').value;
            const ministerio = document.getElementById('evMinisterio').value;
            
            if(!tituloOriginal) return alert("Digite um t√≠tulo!");
            const senha = prompt("üîí Senha de Coordenador:");
            if(!senha) return;

            let tituloFinal = tituloOriginal;
            if(ministerio !== 'Geral') tituloFinal = `${tituloOriginal} - ${ministerio}`;

            let dataAtual = new Date(dataInicio);
            dataAtual.setMinutes(dataAtual.getMinutes() + dataAtual.getTimezoneOffset());
            
            let dataLimite = dataFim ? new Date(dataFim) : new Date(dataInicio);
            dataLimite.setMinutes(dataLimite.getMinutes() + dataLimite.getTimezoneOffset());

            if(dataLimite < dataAtual) return alert("Data Final menor que In√≠cio!");

            let salvou = false;
            while(dataAtual <= dataLimite) {
                const diaString = dataAtual.toISOString().split('T')[0];
                await fetch('/eventos', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ titulo: tituloFinal, data: diaString, ministerio, senha }) });
                dataAtual.setDate(dataAtual.getDate() + 1);
                salvou = true;
            }

            if(salvou) { alert("Salvo!"); carregarEventosDoMes(); abrirModalEvento(dataInicio); }
        }

        async function apagarEvento(id) {
            if(!confirm("Apagar?")) return;
            const senha = prompt("üîí Senha:"); if(!senha) return;
            const res = await fetch(`/eventos/${id}`, { method: 'DELETE', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ senha }) });
            if(res.ok) { const d = document.getElementById('evDataInicio').value; carregarEventosDoMes(); setTimeout(()=>abrirModalEvento(d),500); } else { alert("Erro"); }
        }

        // --- C√ìDIGOS PADR√ÉO (MANTIDOS) ---
        async function carregarDadosIniciais() { try { const r=await fetch('/servos'); todosServos=await r.json(); }catch(e){} }
        async function salvarNovoServo() {
            const nome = document.getElementById('novoNome').value; const min = document.getElementById('novoMinisterio').value;
            if(!nome) return;
            await fetch('/servos', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({nome, ministerio:min}) });
            alert("Salvo!"); toggleArea('areaCadastro'); carregarDadosIniciais();
        }
        function filtrarListaPorMinisterio() {
            const min = document.getElementById('selectMinisterio').value; const cont = document.getElementById('containerChecklist'); cont.innerHTML = "";
            if(!min) return;
            const lista = todosServos.filter(s => min==="Geral" ? true : s.ministerio && s.ministerio.includes(min));
            if(lista.length===0) cont.innerHTML="<p style='text-align:center'>Vazio</p>";
            lista.forEach(s => { cont.innerHTML += `<div class="checklist-item"><label style="display:flex;width:100%;align-items:center"><input type="checkbox" value="${s.id}" class="chk-servo"><span style="flex:1">${s.nome}</span><small>(${s.ministerio})</small></label></div>`; });
        }
        function marcarTodos(b) { document.querySelectorAll('.chk-servo').forEach(c=>c.checked=b); }
        document.getElementById('formEscala').onsubmit = async (e) => {
            e.preventDefault(); const ids = Array.from(document.querySelectorAll('.chk-servo:checked')).map(c=>c.value);
            if(ids.length===0) return alert("Selecione algu√©m!");
            const senha = prompt("üîí Senha:"); if(!senha) return;
            const res = await fetch('/escalar-multiplo', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({servo_ids:ids, data:document.getElementById('dataEscala').value, ministerio_nome:document.getElementById('selectMinisterio').value, responsavel:document.getElementById('inputResponsavel').value, senha}) });
            const j = await res.json(); alert(res.ok?j.mensagem:j.erro);
            if(res.ok) { carregarEscalaDoDia(); marcarTodos(false); }
        };
        async function carregarEscalaDoDia() {
            const data = document.getElementById('dataEscala').value; if(!data) return;
            document.getElementById('dataTitulo').innerText = data.split('-').reverse().join('/');
            const div = document.getElementById('listaEscalados'); div.innerHTML = "Carregando...";
            const res = await fetch(`/escalas/${data}`); const lista = await res.json(); div.innerHTML = "";
            lista.forEach(i => { div.innerHTML += `<div class="card-escala"><div><b>${i.servos?.nome}</b><br><small>${i.ministerio_nome}</small></div><button class="btn-acao" onclick="delEscala(${i.id})">‚ùå</button></div>`; });
        }
        async function delEscala(id) {
            const senha = prompt("Senha:"); if(!senha) return;
            const r = await fetch(`/escalas/${id}`, {method:'DELETE', headers:{'Content-Type':'application/json'}, body:JSON.stringify({senha})});
            if(r.ok) carregarEscalaDoDia(); else alert("Erro");
        }
        function gerarImagem() {
            const area = document.getElementById('areaParaImagem');
            document.querySelectorAll('.btn-acao').forEach(b => b.style.display='none');
            html2canvas(area).then(c => { const a = document.createElement('a'); a.download='escala.jpg'; a.href=c.toDataURL(); a.click(); document.querySelectorAll('.btn-acao').forEach(b => b.style.display='block'); });
        }
        function carregarParaGerenciar() { const div = document.getElementById('listaGerencia'); div.innerHTML=""; todosServos.forEach(s => div.innerHTML+=`<div style="display:flex;justify-content:space-between;padding:5px;border-bottom:1px solid #eee"><span>${s.nome}</span><button onclick="editarServo(${s.id},'${s.nome}','${s.ministerio}')">‚úèÔ∏è</button></div>`); }
        async function editarServo(id,n,m) { const nn = prompt("Nome:",n); const nm=prompt("Minist√©rio:",m); const s=prompt("Senha:"); if(nn&&nm&&s) await fetch(`/servos/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({nome:nn,ministerio:nm,senha:s})}); carregarDadosIniciais(); }

        window.onload = () => { carregarDadosIniciais(); };
    </script>
</body>
</html>